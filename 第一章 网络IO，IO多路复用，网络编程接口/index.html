<!DOCTYPE html>
<html lang="zh_CN" data-theme-mode="light" data-light-theme="daylight" data-dark-theme="midnight">
<head>
    <base href="">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" type="text/css" id="baseStyle" href="stage/build/export/base.css?v=3.5.4"/>
    <link rel="stylesheet" type="text/css" id="themeDefaultStyle" href="appearance/themes/daylight/theme.css?v=3.5.4"/>
    <script src="stage/protyle/js/protyle-html.js?v=3.5.4"></script>
    
    <title>第一章 网络IO，IO多路复用，网络编程接口</title>
    <!-- Exported by SiYuan v3.5.4 -->
    <style>
        body {font-family: var(--b3-font-family);background-color: var(--b3-theme-background);color: var(--b3-theme-on-background)}
        @font-face {
  font-family: "Emojis Additional";
  src: url(appearance/fonts/Noto-COLRv1-2.047/Noto-COLRv1.woff2) format("woff2");
  unicode-range: U+1fae9, U+1fac6, U+1fabe, U+1fadc, U+e50a, U+1fa89, U+1fadf, U+1f1e6-1f1ff, U+1f3f4, U+e0067, U+e0062,
  U+e0065, U+e006e, U+e007f, U+e0073, U+e0063, U+e0074, U+e0077, U+e006c;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis Reset";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  unicode-range: U+263a, U+21a9, U+2642, U+303d, U+2197, U+2198, U+2199, U+2196, U+2195, U+2194, U+2660, U+2665, U+2666, 
  U+2663, U+3030, U+21aa, U+25b6, U+25c0, U+2640, U+203c, U+a9, U+ae, U+2122;
  size-adjust: 85%;
}
@font-face {
  font-family: "Emojis";
  src: local("Segoe UI Emoji"),
  local("Segoe UI Symbol");
  size-adjust: 85%;
}
:root { --b3-font-size-editor: 16px }
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: none }
        
        
    </style>
    
</head>
<body>
<div class="protyle-wysiwyg protyle-wysiwyg--attr" 
style="max-width: 800px;margin: 0 auto;" id="preview"><div data-subtype="h1" data-node-id="20260126225619-3grc1sx" data-type="NodeHeading" class="h1" icon="1f4bb" id="20260126225619-3grc1sx" title="第一章 网络IO，IO多路复用，网络编程接口" updated="20260128100638"><div contenteditable="false" spellcheck="false">第一章 网络IO，IO多路复用，网络编程接口</div><div class="protyle-attr" contenteditable="false"></div></div><div data-subtype="h2" data-node-id="20260126225619-6fqkl4v" data-type="NodeHeading" class="h2" id="20260126225619-6fqkl4v" updated="20260128100638"><div contenteditable="false" spellcheck="false">1.客户端和服务端通信流程</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126230422-be2joy7" data-type="NodeParagraph" class="p" updated="20260126233223" id="20260126230422-be2joy7"><div contenteditable="false" spellcheck="false">​<span contenteditable="false" data-type="img" class="img"><span> </span><span style="width: calc(67% - 8px);"><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg class="svg"><use xlink:href="#iconMore"></use></svg></span></span><img src="assets/image-20260126230440-23b5i19.png" data-src="assets/image-20260126230440-23b5i19.png" alt="image" title="网络IO通信流程图" /><span class="protyle-action__drag"></span><span class="protyle-action__title"><span>网络IO通信流程图</span></span></span><span> </span></span>​</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126230552-g6is0h9" data-type="NodeParagraph" class="p" updated="20260126232625" id="20260126230552-g6is0h9"><div contenteditable="false" spellcheck="false">client流程创建socket-&gt;调用connect -&gt;需要连接的目的IP和目的端口-&gt;连接成功基于socke收发数据，循环往复的接受发送数据</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231024-cfhjji0" data-type="NodeParagraph" class="p" id="20260126231024-cfhjji0" updated="20260126232616"><div contenteditable="false" spellcheck="false">server流程创建socket，绑定服务器IP和端口-&gt;监听端口，此时客户端调用connect-&gt;tcp三次握手（内核态）-&gt;服务端accept-&gt;处</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231232-seqr38u" data-type="NodeParagraph" class="p" id="20260126231232-seqr38u" updated="20260126231307"><div contenteditable="false" spellcheck="false">于阻塞这台，此时可获取标识此客户端的socket</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231029-ssh5wtx" data-type="NodeParagraph" class="p" id="20260126231029-ssh5wtx" updated="20260126231029"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231030-ywwl5bm" data-type="NodeParagraph" class="p" id="20260126231030-ywwl5bm" updated="20260126231045"><div contenteditable="false" spellcheck="false">listenfd == serverfd</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231311-g5wt3dj" data-type="NodeParagraph" class="p" id="20260126231311-g5wt3dj" updated="20260126231311"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231311-ijwtbrm" data-type="NodeParagraph" class="p" id="20260126231311-ijwtbrm" updated="20260126231355"><div contenteditable="false" spellcheck="false">int clientfd = accept(listenfd,&amp;addr,&amp;len)</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231858-ixal33v" data-type="NodeParagraph" class="p" id="20260126231858-ixal33v" updated="20260126231930"><div contenteditable="false" spellcheck="false">int n = read(clientfd,buf,sz)</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231934-fdz81mx" data-type="NodeParagraph" class="p" id="20260126231934-fdz81mx" updated="20260126231934"><div contenteditable="false" spellcheck="false">  
</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231434-l8nb50v" data-type="NodeParagraph" class="p" id="20260126231434-l8nb50v" updated="20260126231434"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231434-id72bbc" data-type="NodeParagraph" class="p" updated="20260126233009" id="20260126231434-id72bbc"><div contenteditable="false" spellcheck="false">accept作用于三次握手中最后一次握手客户端返回ACK的之后，会有全连接队列，这时accept取出一个节点，构造clientfd，客户端源IP地址和端口，循环往复的接受客户端数据，处理客户端数据，发送给客户端数据，当客户端已经调用close，断开连接，会有四次挥手，在第一次挥手时会返回一个fin包，此时server端会在recv_buffer写一个字节EOF,read读取EOF时，n返回0即read返回值为0,</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231209-iy46hpc" data-type="NodeParagraph" class="p" id="20260126231209-iy46hpc" updated="20260126231209"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231209-objcb8s" data-type="NodeParagraph" class="p" id="20260126231209-objcb8s" updated="20260126231209"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126231207-cvtfnj4" data-type="NodeParagraph" class="p" id="20260126231207-cvtfnj4" updated="20260126232105"><div contenteditable="false" spellcheck="false">clientfd内核中对应一个接受缓冲区recv_buff，和一个发送缓冲区send_buff</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126232112-n1gxsyu" data-type="NodeParagraph" class="p" id="20260126232112-n1gxsyu" updated="20260126232201"><div contenteditable="false" spellcheck="false">sz为预期读取字节//不知道客户端发送了多少数据</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126232204-j5sprqr" data-type="NodeParagraph" class="p" id="20260126232204-j5sprqr" updated="20260126232246"><div contenteditable="false" spellcheck="false">n为实际拿到的字节</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126232224-p1lpfvc" data-type="NodeParagraph" class="p" id="20260126232224-p1lpfvc" updated="20260126232306"><div contenteditable="false" spellcheck="false">buf用户态容器，将内核态buff拷贝到buff来</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126232452-8wggzb8" data-type="NodeParagraph" class="p" id="20260126232452-8wggzb8" updated="20260126232838"><div contenteditable="false" spellcheck="false">int n = write(clientfd,buff,sz)</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126232555-g2z93xb" data-type="NodeParagraph" class="p" id="20260126232555-g2z93xb" updated="20260126232604"><div contenteditable="false" spellcheck="false">n为实际写入的字节数量</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126233133-51b9nfa" data-type="NodeParagraph" class="p" updated="20260126233133" id="20260126233133-51b9nfa"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126233133-5fiuyx0" data-type="NodeParagraph" class="p" id="20260126233133-5fiuyx0" updated="20260126233133"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126233133-cuvy7gu" data-type="NodeParagraph" class="p" id="20260126233133-cuvy7gu" updated="20260126233146"><div contenteditable="false" spellcheck="false">阻塞线程等待客户端发送数据</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126233256-eu2j2rc" data-type="NodeParagraph" class="p" updated="20260126233344" id="20260126233256-eu2j2rc"><div contenteditable="false" spellcheck="false">​<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg class="svg"><use xlink:href="#iconMore"></use></svg></span></span><img src="assets/image-20260126233257-eb9ry21.png" data-src="assets/image-20260126233257-eb9ry21.png" alt="image" title="阻塞网络IO通信" style="height: 50vh" /><span class="protyle-action__drag"></span><span class="protyle-action__title"><span>阻塞网络IO通信</span></span></span><span> </span></span>​</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126233225-qh0bre4" data-type="NodeParagraph" class="p" id="20260126233225-qh0bre4" updated="20260126234121"><div contenteditable="false" spellcheck="false">阻塞IO与非阻塞IO的区别</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126234124-r0mo97w" data-type="NodeParagraph" class="p" id="20260126234124-r0mo97w" updated="20260126234148"><div contenteditable="false" spellcheck="false">1.什么是阻塞   IO未就绪的情况下，会阻塞线程</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126234148-rfjez0s" data-type="NodeParagraph" class="p" id="20260126234148-rfjez0s" updated="20260126234257"><div contenteditable="false" spellcheck="false">2.什么决定是阻塞IO还是非阻塞IO？ socket属性 默认情况下是阻塞的 fnctl接口设置非阻塞</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126234258-jgkrzz0" data-type="NodeParagraph" class="p" id="20260126234258-jgkrzz0" updated="20260126234347"><div contenteditable="false" spellcheck="false">fcntl(new_fd,F_SETEL,O_NONBLOCK)</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126234348-h6ggbe2" data-type="NodeParagraph" class="p" updated="20260126234528" id="20260126234348-h6ggbe2"><div contenteditable="false" spellcheck="false">3.区别在就绪情况下即数据拷贝状态无论使用阻塞或者非阻塞都是在执行拷贝的行为，区别在于IO未就绪的情况下，即read/recv无数据时，阻塞IO阻塞线程等待，非阻塞不会阻塞线程</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127001131-2ph0n8i" data-type="NodeParagraph" class="p" id="20260127001131-2ph0n8i" updated="20260127001131"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127001131-f90xkq0" data-type="NodeParagraph" class="p" id="20260127001131-f90xkq0" updated="20260127001136"><div contenteditable="false" spellcheck="false">网络IO流程，</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127095357-jpnnlw2" data-type="NodeParagraph" class="p" id="20260127095357-jpnnlw2" updated="20260127095357"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127095358-ja17en5" data-type="NodeParagraph" class="p" id="20260127095358-ja17en5" updated="20260127095405"><div contenteditable="false" spellcheck="false">IO多路复用</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127095405-chcjm7z" data-type="NodeParagraph" class="p" id="20260127095405-chcjm7z" updated="20260127095438"><div contenteditable="false" spellcheck="false">当使用阻塞IO时，需要有一个线程去对应一个客户端（对应一条链接）</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127095452-cmt67h7" data-type="NodeParagraph" class="p" updated="20260127095506" id="20260127095452-cmt67h7"><div contenteditable="false" spellcheck="false">复用：用一个线程同时检测多路socket是否就绪</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127095548-w5fw62o" data-type="NodeParagraph" class="p" id="20260127095548-w5fw62o" updated="20260127095548"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127095548-56pqssi" data-type="NodeParagraph" class="p" id="20260127095548-56pqssi" updated="20260127100011"><div contenteditable="false" spellcheck="false">io多路复用是否可以操纵IO，不可以，只能检测recv_buffer和全连接队列中是否有数据</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126234528-roroi8p" data-type="NodeParagraph" class="p" id="20260126234528-roroi8p" updated="20260127100114"><div contenteditable="false" spellcheck="false">网络io也可以检测socket是否就绪，但是只能检测一个socket</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127143004-i97bmbz" data-type="NodeParagraph" class="p" id="20260127143004-i97bmbz" updated="20260127143004"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127143004-o83a2qz" data-type="NodeParagraph" class="p" id="20260127143004-o83a2qz" updated="20260127143004"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127143005-lglxg5a" data-type="NodeParagraph" class="p" id="20260127143005-lglxg5a" updated="20260127143029"><div contenteditable="false" spellcheck="false">io多路复用共有三种接口，select,poll,epoll</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127143030-ouwgs2b" data-type="NodeParagraph" class="p" id="20260127143030-ouwgs2b" updated="20260127143032"><div contenteditable="false" spellcheck="false">区别</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127143032-c0h8t31" data-type="NodeParagraph" class="p" id="20260127143032-c0h8t31" updated="20260127143058"><div contenteditable="false" spellcheck="false">select:数组实现，1024限制</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127143038-8o7evku" data-type="NodeParagraph" class="p" updated="20260127143100" id="20260127143038-8o7evku"><div contenteditable="false" spellcheck="false">poll:链表，无限制</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127143043-xl4qykj" data-type="NodeParagraph" class="p" updated="20260127143103" id="20260127143043-xl4qykj"><div contenteditable="false" spellcheck="false">epoll：红黑树，无限制</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127143115-cu40nrg" data-type="NodeParagraph" class="p" id="20260127143115-cu40nrg" updated="20260127143115"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127143115-eu2hks1" data-type="NodeParagraph" class="p" id="20260127143115-eu2hks1" updated="20260127143450"><div contenteditable="false" spellcheck="false">为什么需要io多路复用，非阻塞IO不知道什么时机去调用read/recv，只能轮询确认read/recv是否存在数据，io多路复用刚好可以解决什么时间去调用网络io</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127172652-jetfktg" data-type="NodeParagraph" class="p" id="20260127172652-jetfktg" updated="20260127172652"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127172652-dwwulk2" data-type="NodeParagraph" class="p" id="20260127172652-dwwulk2" updated="20260127172652"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127172653-fgi7xzu" data-type="NodeParagraph" class="p" id="20260127172653-fgi7xzu" updated="20260127172701"><div contenteditable="false" spellcheck="false">边缘触发和水平触发</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127172704-ws3q6kf" data-type="NodeParagraph" class="p" id="20260127172704-ws3q6kf" updated="20260127172738"><div contenteditable="false" spellcheck="false">1，上述为io多路复用触发的模式</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260126234528-xjjk2la" data-type="NodeParagraph" class="p" updated="20260127172813" id="20260126234528-xjjk2la"><div contenteditable="false" spellcheck="false">2.不同io多路复用的触发方式 select\poll\epoll</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127172815-u7yphdd" data-type="NodeParagraph" class="p" id="20260127172815-u7yphdd" updated="20260127172824"><div contenteditable="false" spellcheck="false">select\poll只有水平触发</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260127172853-kl5jk2n" data-type="NodeParagraph" class="p" id="20260127172853-kl5jk2n" updated="20260128100207"><div contenteditable="false" spellcheck="false">epoll 既有水平触发和边缘触发</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260128100207-1vtet4m" data-type="NodeParagraph" class="p" id="20260128100207-1vtet4m" updated="20260128100232"><div contenteditable="false" spellcheck="false">具体</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260128100235-4dbuomm" data-type="NodeParagraph" class="p" id="20260128100235-4dbuomm" updated="20260128100638"><div contenteditable="false" spellcheck="false">int n = epoll_wait（epfd,evs,evs_len,timeout)</div><div class="protyle-attr" contenteditable="false"></div></div><div data-node-id="20260128100156-r2ydk5n" data-type="NodeParagraph" class="p" id="20260128100156-r2ydk5n" updated="20260128100156"><div contenteditable="false" spellcheck="false">‍</div><div class="protyle-attr" contenteditable="false"></div></div></div>
<script src="appearance/icons/material/icon.js?v=3.5.4"></script>
<script src="stage/build/export/protyle-method.js?v=3.5.4"></script>
<script src="stage/protyle/js/lute/lute.min.js?v=3.5.4"></script>  
<script>
    
    window.siyuan = {
      config: {
        appearance: { mode: 0, codeBlockThemeDark: "base16/dracula", codeBlockThemeLight: "github" },
        editor: { 
          codeLineWrap: true,
          fontSize: 16,
          codeLigatures: false,
          plantUMLServePath: "https://www.plantuml.com/plantuml/svg/~1",
          codeSyntaxHighlightLineNum: false,
          katexMacros: decodeURI(`%7B%7D`),
        }
      },
      languages: {copy:"复制"}
    };
    const previewElement = document.getElementById('preview');
    Protyle.highlightRender(previewElement, "stage/protyle");
    Protyle.mathRender(previewElement, "stage/protyle", false);
    Protyle.mermaidRender(previewElement, "stage/protyle");
    Protyle.flowchartRender(previewElement, "stage/protyle");
    Protyle.graphvizRender(previewElement, "stage/protyle");
    Protyle.chartRender(previewElement, "stage/protyle");
    Protyle.mindmapRender(previewElement, "stage/protyle");
    Protyle.abcRender(previewElement, "stage/protyle");
    Protyle.htmlRender(previewElement);
    Protyle.plantumlRender(previewElement, "stage/protyle");
    document.querySelectorAll(".protyle-action__copy").forEach((item) => {
      item.addEventListener("click", (event) => {
            navigator.clipboard.writeText(item.parentElement.nextElementSibling.textContent.trimEnd().replace(/ /g, " ").replace(/‍```/g, "```"));
            event.preventDefault();
            event.stopPropagation();
      })
    });
</script>
</body></html>